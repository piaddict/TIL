# 운영체제

## 운영체제 개요

### 운영체제의 개요

#### 컴퓨터 시스템과 운영체제

1. 하드웨어와 응용 프로그램 사이에 운영체제를 두고 하드웨어 제어는 운영체제만 하도록 하였다
2. 여러 응용 프로그램이 동시에 수행되더라도 운영체제가 중간에서 충돌 없이 자원을 효율적으로 나누어준다
3. 응용 프로그램이 직접 하드웨어에 접근하는 것을 방지하기 위해서 슈퍼바이저 모드와 보호보드가 사용된다.
  > 슈퍼바이저모드(커널모드): 하드웨어를 직접 제어할 수 있는 CPU의 명령어를 사용할 수 있는 모드로 운영체제의 커널이 동작되는 모드
  > 보호모드(사용자모드): 하드웨어를 직접 제어하는 CPU의 명령어를 사용할 수 없는 모드로 응용 프로그램이 동작하는 모드

#### 커널

응용 프로그램과 하드웨어 수준의 처리 사이의 가교 역할을 하는 운영체제의 핵심 요소를 Kernel 이라고 한다.
커널은 운영체제마다 구성 방식이 다른데, 대표적으로 일체형 커널과 마이크로 커널이 있다.

일체형 커널 (monolithic kernel)

운영체제의 모든 서비스가 커널 내에 포함된 커널이다.
장점은 커널 내부 요소로 존재하는 서비스들이 서로 효율적으로 상호작용 할 수 있다는 것이다.
단점은 하나의 요소에서 오류가 발생하면 시스템 전체에 장애를 일으킬 수 있다는 것이다.
UNIX와 Linux 운영체제가 일체형 커널이다.

마이크로 커널 (micro kernel)

운영체제의 대부분 요소들을 커널 외부로 분리하여 커널 내부에는 메모리 관리,멀티태스킹, 프로세스 간 통신(IPC) 등의 최소한의 요소들만 남겨 놓은 커널이다.
파일시스템, 장치 드러이버, 네트워크 프로토콜 들은 보호 모드에서 동작하도록 분리된다.
장점은 새로운 서비스를 추가하여 운영체제를 확장하기 쉬우며 커널 외부의 요소에 문제가 발생해도 커널 자체에는 영향이 없어 안정성이 우수하다.
단점은 커널 외부에 존재하는 운영체제 요소들 사이에 데이터 전달이 필요한 경우에는 IPC를 통해야 하기 때문에 성능저하가 발생한다.

### 운영체제의 구성

#### 프로세스 관리자

프로세스(실행중인 프로그램 또는 작업) 관리자는 프로세스들을 생성하고 삭제하며 CPU에 할당하기 위한 스케줄을 결정한다.
또한 각 프로세스의 상태(준비, 실행, 대기 등)를 관리하며 상태 전이를 처리한다.

#### 메모리 관리자

메모리 관리자는 주기억장치를 관리한다. 요청에 따라 메모리를 할당하고 테이블을 만들어 관리한다. 회수 시점에 메모리를 회수한다.
또 다른 역할은 운영체제가 점유하고 있는 주기억 장치의 공간을 지키는 것이다.

#### 장치 관리자

장치 관리자는 시스템의 모든 장치를 관리한다. 시스템 스케줄링 기법을 기반으로 장치를 효율적으로 할당한다.

#### 파일 관리자

파일 관리자는 시스템의 모든 파일을 관리한다. 또한 파일의 접근 제한을 관리하거나 파일을 열어 자원을 할당하거나 파일을 닫아 자원을 회수한다.

### 운영체제 유형

#### 일괄처리 운영체제

일괄처리(batch processing) 운영체제는 초창기 컴퓨터에서 사용되었던 유형으로 작업을 모아서 처리하는 방식이다.

#### 대화형 운영체제

대화형(interactive) 운영체제는 시분할 운영체제라고도 하며,
응답시간 측면에서 일괄처리 운영체제보다는 빠르지만 실시간 운영체제보다는 느리다.
대화형 운영체제는 이용자에게 즉각적인 피드백을 제공하고 응답시간은 사용 중인 이용자의 수에 따라 수 분 또는 수 초 안에 처리된다.

#### 실시간 운영체제

실시간(real-time) 운영체제는 운영체제 중 가장 빠른 응답시간을 가진다.
데이터의 처리가 빨라야 하는 환경인, 우주 비행 시스템, 미사일 제어, 증권 거래 등의 분야에 사용된다.

#### 하이브리드 운영체제

하이브리드(hybrid) 운영체제는 일괄처리와 대화형 운영체제의 결합으로 볼 수 있다.
각 이용자가 터미널을 통해 접속하고 빠른 응답시간을 얻을 수 있기 때문에 대화형이지만,
작업량이 많지 않을 경우 운영체제는 백그라운드에서 배치 프로그램을 받아들이고 실행한다.
현재 사용되고 있는 대부분의 대형 컴퓨터 시스템은 하이브리드 운영체제라고 할 수 있다.

## 프로세스 개요

### 프로세스

프로세스란 실행 중인 프로그램을 의미함
프로그램을 실행시키려면 운영체제로부터 동작하는데 필요한 CPU, 메모리, 입출력장치, 파일 등의 자원을 할당받아야 한다.

프로세스는 사용자가 실행시킨 프로그램 뿐만 아니라 스풀링과 같은 시스템 태스크도 각각 하나의 프로세스 이다.

운영체제는 프로세스의 상태를 관리하며 필요한 경우 프로세스가 다른 상태로 전이되도록 처리한다.

#### 프로세스의 상태 변화

프로세스는 `생성 -> [ 준비, 실행, 대기 ] -> 종료`의 다섯가지 중 하나의 상태를 가진다.

1. 생성 -> 준비 : 정의된 정책에 따라 스케줄러에 의해 호출된다. 이용가능한 메모리와 요구 장치를 검사한다.
2. 준비 -> 실행 : 사전에 정의된 알고리즘 (FCFS, SJF, SRT, RR ...)에 따라 스케줄러에 의해 처리된다 (dispatch)
3. 실행 -> 준비 : 할당 시간의 만료나 우선순위 알고리즘 채택시 높은 우선순위의 프로세스가 오는 경우 후순위로 처리된다.
4. 실행 -> 대기 : I/O 요구, 페이지 교환요구 같은 작업에 의해 일어난다. 이러한 작업은 상대적으로 오랜시간이 걸리므로 그 동안 다른 프로세스에 자원을 할당한다.
5. 대기 -> 준비 : I/O 장치 관리자의 신호에 의해 일어난다. 페이지 교환의 경우 페이지 인터럽트 핸들러가 메모리에 페이지가 있다는 신호를 보내면 프로세스는 준비큐에 놓이게 된다.
6. 실행 -> 종료 : 프로세스를 정상 종료하거나 에러발생시 강제종료시 스케줄러에 의해 수행된다.

#### 프로세스 제어 블록

프로세스의 관리를 위해서 운영체제는 각 프로세스 마다 프로세스 제어 블록 (PCB)을 두고 프로세스 정보를 보관한다.

1. 프로세스 상태
2. 프로세스 번호(PID)
3. 프로그램 카운터(PC): 프로세스 수행을 위한 다음명령의 주소 표시
4. 레지스터(register): CPU의 레지스터에 해당하는 정보를 포함한다. 실행상태에서 다른 상태로 전의되는 경우 CPU의 레지스터 정보를 저장하여 나중에 다시 실행상태로 전이될 때 복구하여 프로세스 수행을 계속할 수 있게 한다.
5. 메모리: 프로세스가 저장된 주소와 가상메모리의 가상주소, 실제 주소의 mapping 정보, base register와 bound register 등의 정보를 포함
6. 프로세스 우선순위: 우선순위 스케줄링시 어떤 작업을 선택할 것인지에 대한 정보
7. 회계정보: 성능 측정과 순위에 대한 정보 - CPU 사용시간, 프로세스 존재시간, 메모리사용량 ...

#### 프로세스 생성과 종료

##### 프로세스 생성

프로세스는 프로세스 생성 시스템 호출을 이용하여 어러 개의 프로세스를 호출 할 수 있다.
이 프로세스를 부모 프로세스라 하고, 생성된 새로운 프로세스는 자식 프로세스라 한다.
부모 프로세스는 자식 프로세스에 자원을 나누어 주거나 공유할 수 있다.
물리/논리적 자원을 얻는 것 이외에도 몇몇 초기화 데이터가 부모 프로세스에서 자식 프로세스로 전달된다.

프로세스 생성을 위해서는 프로세스 이름 결정, 프로세스 준비 큐에 삽입, 우선순위 부여, 프로세스 제어블록 생성 등이 필요하다.

##### 프로세스 종료

프로세스는 마지막 문장이 끝났을 때 종료된다. 이때 프로세스는 부모 프로세스에게 실행결과를 되돌려준다.
또한 프로세스가 종료될 때 또 다른 상황이 발생할 수도 있다. (`exit()`와 같은 시스템 호출로 다른 자식프로세스를 종료...)

부모 프로세스는 다음과 같은 이유로 자식 프로세스를 종료할 수 있다.

1. 자식 프로세스가 할당된 자원의 사용 초과 (자식 프로세스의 상태를 검사할 수 있어야 함)
2. 자식 프로세스에게 할당된 작업이 더 이상 필요하지 않을 때

마지막으로 어떤 프로세스가 종료된다면 자식 프로세스는 모두 종료된다 이를 cascading termination 이라하고 OS에 의해 실행된다.

#### 프로세스 간의 관계

##### 독립적 프로세스

independent process란 시스템에서 실행중인 다른 프로세스의 영향을 받지도 주지도 않는 프로세스를 의미한다.
일반적으로 다른 프로세스와 데이터를 공유하지 않는 프로세스는 독립적이다.

1. 프로세스의 상태는 다른 프로세스와 공유되지 않는다.
2. 프로세스의 실행결과는 입력상태에 의해서만 결정된다.
3. 프로세스의 실행은 같은 입력에 대하여 항상 동일하다.
4. 프로세스의 실행은 타 프로세스와 무관하게 중된되거나 재시작될 수 있다.

#### 유기적 프로세스

cooperating process란 실행중인 다른 프로세스와 영향을 주고 받으며 동작하는 프로세스이다.
일반적으로 다른 프로세스와 데이터를 공유하는 프로세스는 유기적 프로세스 이다.

1. 프로세스의 상태는 다른 프로세스와 공유된다.
2. 프로세스의 실행결과는 실행순서에 좌우되므로 미리 예측할 수 없다.
3. 프로세스의 실행결과는 동일한 입력에 대하여 동일함을 보장하지 않는다.

### 쓰레드 (Thread)

일반적으로 다중 프로세싱 시스템에서 기본적 처리단위는 프로세스이다.
하나의 프로그램을 수행하기 위해 하나의 주소공간과 주소공간내에서 하나의 제어흐름으로 구성된 프로세스를 사용한다.
하나의 프로세스 내에서 프로그램이 수행될 때 각각의 실행 단위 시간안에 하나의 실행점만이 존재한다.
즉 단일 프로세스 내에서 동시/병렬 처리가 불가능하다.

쓰레드는 프로세스 내에서 다중처리를 위하여 제안된 개념으로, 실행 단위를 프로세스에서 한 단계 낮추어 규정한 것이다.

기존의 개념에서 프로세스는 자원 소유의 단위와 디스패칭의 단위로 설명될 수 있다.
최근에 개발된 많은 운영체제에서는 디스패칭의 단위를 보통 쓰레드 혹은 경량 프로세스라 하고, 자원 소유의 단위는 그대로 프로세스 또는 작업이라 부르고 있다.

쓰레드는 제어의 흐름을 의미하고 프로세스에서 실행의 개념만을 분리한 것

쓰레드 내에서는 하나의 실행점만 존재하고, 각 쓰레드는 프로그램 카운터와 스택, 쓰레드 관리 정보등과 같은 최소한의 정보만으로 구성된다.
쓰레드도 프로세스와 마찬가지로 생성 후 준비, 실행, 대기 상태를 거친 후 종료상태에 이르게된다.

### 스케줄링

스케줄링이란 여러가지 작업들의 처리순서를 결정하는 것을 의미한다.

#### 스케줄링 단계

##### 상위단계 스케줄링

시스템에 들어오는 작업들을 선택하여 프로세스를 생성한 후 프로세스 준비 큐에 전달

##### 하위단계 스케줄링

사용가능한 CPU를 준비상태의 어느 프로세스에 배당할지를 결정

CPU를 배당받은 프로세스는 실행상태가 된다.
이렇게 프로세스가 준비상태에서 실행상태로 바뀌는 것을 dispatch라 하고, 하위단계 스케줄링의 실행주체는 dispatcher가 된다.

하위 단계 스케줄링은 빈번하게 일어나므로 dispatcher는 메모리에 상주해야 한다.

##### 중간단계 스케줄링

프로세스를 일시적으로 메모리에서 제거하여 중지 시키거나 다시 활성화 시켜서 시스템에 대한 단기적 부하를 조절한다.

#### 스케줄링 정책

운영체제의 목적(처리량 극대화, 반환시간 최소화, CPU 활용의 극대화, 빠른 응답시간 ...)에 맞춰 프로세스에게 자원을 할당한다.

##### 선점 스케줄링 정책 (preemptive scheduling policy)

진행 중인 작업에 인터럽트를 걸고 다른 작업에 CPU를 할당하는 스케줄링 전략이다.
선점 스케줄링 방식은 시간 할당 방식에서 주로 사용된다.

높은 우선순위의 프로세스가 긴급한 경우 유용하다. 또한 필요 프로세스가 자원을 선점하므로 예측가능하다.
하지만 프로세스를 종료하지 않은채 자원을 다른 프로세스에 할당하려면 문맥교환이 필요하므로 오버헤드가 발생한다.

문맥교환(context switching)이란 CPU가 현재 실행하고 있는 프로세스의 context를 프로세스 제어블록(PCB)에 저장하고,
다음 프로세스의 PCB로 부터 context를 복원하는 작업을 의미한다.

##### 비선점 스케줄링 정책 (nonpreemptive scheduling policy)

프로세스가 CPU를 할당받아 실행이 시작되면 프로세스 자체가 I/O 인터럽트를 걸거나 프로세스를 종료할 때 까지
(예외적으로 무한루프를 숭해중인 경우 선점/비선점에 관계없이 인터럽트가 걸린다) 실행상태에 있게 된다.

우선순위에 관계없이 대기 중인 프로세스는 변동이 벗으므로 응답시간 예측이 가능하다.

## 스케줄링 알고리즘

### 스케줄링 성능 평가 기준

평균 대기시간:
각 프로세스가 수행이 완료될 때까지 준비 큐에서 기다리는 시간합의 평균

평균 반환시간:
각 프로세스가 생성된 시점부터 수행이 완료된 시점까지의 소요시간의 평균

### FCFS 스케줄링

First Come First Served 스케줄링은 비선점 방법이다.

프로세스는 준비 큐에서 도착순서에 따라 디스패치되며,
일단 한 프로세스가 CPU를 차지하면 그 프로세스의 수행이 완료된 후에 다음 프로세스가 수행된다.
